name: CMake CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  MSYS_NO_PATHCONV: 1  # Prevent Git Bash path conversion on Windows

jobs:
  # ============================================================================
  # Core Library Build and Test
  # ============================================================================
  build-and-test:
    name: ${{ matrix.os }} - ${{ matrix.compiler }} - ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        compiler: [default]
        build_type: [Release, Debug]
        include:
          # Test with GCC on Linux
          - os: ubuntu-latest
            compiler: gcc
            build_type: Release
            cc: gcc-13
            cxx: g++-13
          # Test with Clang on Linux
          - os: ubuntu-latest
            compiler: clang
            build_type: Release
            cc: clang-18
            cxx: clang++-18
          # Test with older macOS
          - os: macos-13
            compiler: default
            build_type: Release

    steps:
    - uses: actions/checkout@v4

    - name: Setup compiler (Linux)
      if: runner.os == 'Linux' && matrix.compiler != 'default'
      run: |
        if [ "${{ matrix.compiler }}" == "gcc" ]; then
          sudo apt-get update
          sudo apt-get install -y gcc-13 g++-13
        elif [ "${{ matrix.compiler }}" == "clang" ]; then
          sudo apt-get update
          sudo apt-get install -y clang-18
        fi
        echo "CC=${{ matrix.cc }}" >> $GITHUB_ENV
        echo "CXX=${{ matrix.cxx }}" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DLIBSVM_BUILD_APPS=ON \
          -DLIBSVM_BUILD_EXAMPLES=OFF

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{ matrix.build_type }}

    - name: Test - svm-train (Non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        ${{github.workspace}}/build/bin/svm-train \
          ${{github.workspace}}/examples/data/heart_scale \
          ${{github.workspace}}/build/heart_scale.model

    - name: Test - svm-train (Windows)
      if: runner.os == 'Windows'
      run: |
        & "${{github.workspace}}/build/bin/${{ matrix.build_type }}/svm-train.exe" `
          "${{github.workspace}}/examples/data/heart_scale" `
          "${{github.workspace}}/build/heart_scale.model"

    - name: Test - svm-predict (Non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        ${{github.workspace}}/build/bin/svm-predict \
          ${{github.workspace}}/examples/data/heart_scale \
          ${{github.workspace}}/build/heart_scale.model \
          ${{github.workspace}}/build/heart_scale.output

    - name: Test - svm-predict (Windows)
      if: runner.os == 'Windows'
      run: |
        & "${{github.workspace}}/build/bin/${{ matrix.build_type }}/svm-predict.exe" `
          "${{github.workspace}}/examples/data/heart_scale" `
          "${{github.workspace}}/build/heart_scale.model" `
          "${{github.workspace}}/build/heart_scale.output"

    - name: Test - svm-scale (Non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        ${{github.workspace}}/build/bin/svm-scale \
          -l -1 -u 1 \
          ${{github.workspace}}/examples/data/heart_scale \
          > ${{github.workspace}}/build/heart_scale.scaled

    - name: Test - svm-scale (Windows)
      if: runner.os == 'Windows'
      run: |
        & "${{github.workspace}}/build/bin/${{ matrix.build_type }}/svm-scale.exe" `
          -l -1 -u 1 `
          "${{github.workspace}}/examples/data/heart_scale" `
          | Out-File -FilePath "${{github.workspace}}/build/heart_scale.scaled"

    - name: Verify outputs (Non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if [ ! -f "${{github.workspace}}/build/heart_scale.model" ]; then
          echo "Error: Model file not created"
          exit 1
        fi
        if [ ! -f "${{github.workspace}}/build/heart_scale.output" ]; then
          echo "Error: Prediction output not created"
          exit 1
        fi
        echo "All output files created successfully"

    - name: Verify outputs (Windows)
      if: runner.os == 'Windows'
      run: |
        if (!(Test-Path "${{github.workspace}}/build/heart_scale.model")) {
          Write-Error "Error: Model file not created"
          exit 1
        }
        if (!(Test-Path "${{github.workspace}}/build/heart_scale.output")) {
          Write-Error "Error: Prediction output not created"
          exit 1
        }
        Write-Host "All output files created successfully"

  # ============================================================================
  # Build with OpenMP
  # ============================================================================
  build-with-openmp:
    name: OpenMP - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
    - uses: actions/checkout@v4

    - name: Install OpenMP (macOS)
      if: runner.os == 'macOS'
      shell: bash
      run: brew install libomp

    - name: Configure CMake with OpenMP
      shell: bash
      env:
        MSYS2_ARG_CONV_EXCL: "*"
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=Release \
          -DLIBSVM_ENABLE_OPENMP=ON \
          -DLIBSVM_BUILD_APPS=ON

    - name: Build
      shell: bash
      run: cmake --build ${{github.workspace}}/build --config Release

    - name: Test with OpenMP
      shell: bash
      run: |
        ${{github.workspace}}/build/bin/svm-train \
          ${{github.workspace}}/examples/data/heart_scale

  # ============================================================================
  # Shared Library Build
  # ============================================================================
  build-shared-library:
    name: Shared Library - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=ON \
          -DLIBSVM_BUILD_APPS=ON

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config Release

    - name: Verify shared library (Non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if [ "${{ runner.os }}" == "macOS" ]; then
          test -f "${{github.workspace}}/build/lib/libsvm.dylib" || exit 1
        else
          test -f "${{github.workspace}}/build/lib/libsvm.so" || exit 1
        fi
        echo "Shared library built successfully"

    - name: Verify shared library (Windows)
      if: runner.os == 'Windows'
      run: |
        if (Test-Path "${{github.workspace}}/build/bin/Release/svm.dll") {
          Write-Host "Shared library built successfully"
        } elseif (Test-Path "${{github.workspace}}/build/bin/svm.dll") {
          Write-Host "Shared library built successfully"
        } else {
          Write-Error "Shared library not found"
          exit 1
        }

  # ============================================================================
  # Python Bindings
  # ============================================================================
  test-python-bindings:
    name: Python ${{ matrix.python-version }} - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.11', '3.13']

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Python dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy

    - name: Build shared library
      shell: bash
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=ON \
          -DLIBSVM_BUILD_PYTHON=ON
        cmake --build ${{github.workspace}}/build --config Release

    - name: Copy library to Python package (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if [ "${{ runner.os }}" == "macOS" ]; then
          cp ${{github.workspace}}/build/lib/libsvm*.dylib ${{github.workspace}}/bindings/python/libsvm/ 2>/dev/null || \
          cp ${{github.workspace}}/build/lib/libsvm.dylib ${{github.workspace}}/bindings/python/libsvm/
        else
          cp ${{github.workspace}}/build/lib/libsvm.so* ${{github.workspace}}/bindings/python/libsvm/ 2>/dev/null || \
          cp ${{github.workspace}}/build/lib/libsvm.so ${{github.workspace}}/bindings/python/libsvm/
        fi

    - name: Copy library to Python package (Windows)
      if: runner.os == 'Windows'
      run: |
        if (Test-Path "${{github.workspace}}/build/bin/Release/svm.dll") {
          Copy-Item "${{github.workspace}}/build/bin/Release/svm.dll" "${{github.workspace}}/bindings/python/libsvm/"
        } elseif (Test-Path "${{github.workspace}}/build/bin/svm.dll") {
          Copy-Item "${{github.workspace}}/build/bin/svm.dll" "${{github.workspace}}/bindings/python/libsvm/"
        } else {
          Write-Error "svm.dll not found"
          exit 1
        }

    - name: Test Python import
      shell: bash
      run: |
        cd ${{github.workspace}}/bindings/python
        python -c "from libsvm import svmutil; print('Python bindings import successful')"

    - name: Test Python training
      shell: bash
      run: |
        cd ${{github.workspace}}/bindings/python
        python -c "
        from libsvm import svmutil
        import sys
        sys.path.insert(0, '.')
        y, x = svmutil.svm_read_problem('../../examples/data/heart_scale')
        prob = svmutil.svm_problem(y[:200], x[:200])
        param = svmutil.svm_parameter('-q')
        model = svmutil.svm_train(prob, param)
        print('Python training test successful')
        "

  # ============================================================================
  # Java Bindings
  # ============================================================================
  test-java-bindings:
    name: Java ${{ matrix.java-version }} - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        java-version: ['11', '17', '21']

    steps:
    - uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java-version }}

    - name: Install m4 (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: sudo apt-get update && sudo apt-get install -y m4

    - name: Install m4 (macOS)
      if: runner.os == 'macOS'
      shell: bash
      run: brew install m4

    - name: Install m4 (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        choco install msys2 -y
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm m4"
        echo "C:\tools\msys64\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Set PATH for m4 (macOS)
      if: runner.os == 'macOS'
      shell: bash
      run: echo "$(brew --prefix m4)/bin" >> $GITHUB_PATH

    - name: Configure CMake (Non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Release -DLIBSVM_BUILD_JAVA=ON

    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $env:PATH = "C:\tools\msys64\usr\bin;" + $env:PATH
        cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Release -DLIBSVM_BUILD_JAVA=ON -DM4_EXECUTABLE=C:/tools/msys64/usr/bin/m4.exe

    - name: Build Java bindings (Non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: cmake --build ${{github.workspace}}/build --target java-bindings

    - name: Build Java bindings (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $env:PATH = "C:\tools\msys64\usr\bin;" + $env:PATH
        cmake --build ${{github.workspace}}/build --target java-bindings --config Release

    - name: Test Java bindings (Non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        java -classpath ${{github.workspace}}/build/bindings/java/libsvm.jar svm_train \
          ${{github.workspace}}/examples/data/heart_scale \
          ${{github.workspace}}/build/heart_scale_java.model

    - name: Test Java bindings (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        java -classpath "${{github.workspace}}/build/bindings/java/libsvm.jar" svm_train `
          "${{github.workspace}}/examples/data/heart_scale" `
          "${{github.workspace}}/build/heart_scale_java.model"

  # ============================================================================
  # Qt/svm-toy Example
  # ============================================================================
  test-qt-example:
    name: Qt Example - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        # Skip Windows due to Qt installation complexity

    steps:
    - uses: actions/checkout@v4

    - name: Install Qt (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y qtbase5-dev qtbase5-dev-tools

    - name: Install Qt (macOS)
      if: runner.os == 'macOS'
      shell: bash
      run: |
        brew install qt@5
        echo "CMAKE_PREFIX_PATH=$(brew --prefix qt@5)" >> $GITHUB_ENV

    - name: Configure CMake
      shell: bash
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Release -DLIBSVM_BUILD_EXAMPLES=ON

    - name: Build svm-toy
      shell: bash
      run: cmake --build ${{github.workspace}}/build --target svm-toy

    - name: Verify svm-toy binary
      shell: bash
      run: test -f ${{github.workspace}}/build/bin/svm-toy

  # ============================================================================
  # Static Analysis
  # ============================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install cppcheck
      shell: bash
      run: sudo apt-get update && sudo apt-get install -y cppcheck

    - name: Run cppcheck
      continue-on-error: true
      shell: bash
      run: |
        cppcheck --enable=warning,performance,portability \
          --suppress=missingIncludeSystem \
          --error-exitcode=1 \
          src/ apps/ examples/svm-toy/

  # ============================================================================
  # Installation Test
  # ============================================================================
  test-installation:
    name: Installation Test - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake
      shell: bash
      env:
        MSYS2_ARG_CONV_EXCL: "*"
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/install \
          -DLIBSVM_BUILD_APPS=ON

    - name: Build
      shell: bash
      run: cmake --build ${{github.workspace}}/build

    - name: Install
      shell: bash
      run: cmake --install ${{github.workspace}}/build

    - name: Verify installation
      shell: bash
      run: |
        test -f ${{github.workspace}}/install/include/svm.h
        test -f ${{github.workspace}}/install/bin/svm-train
        test -f ${{github.workspace}}/install/bin/svm-predict
        test -f ${{github.workspace}}/install/bin/svm-scale
        echo "Installation verification successful"

    - name: Test find_package
      shell: bash
      env:
        MSYS2_ARG_CONV_EXCL: "*"
      run: |
        mkdir -p ${{github.workspace}}/test_project
        cat > ${{github.workspace}}/test_project/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.16)
        project(TestLibSVM)
        find_package(LibSVM REQUIRED)
        add_executable(test_app test.cpp)
        target_link_libraries(test_app LibSVM::svm)
        EOF
        cat > ${{github.workspace}}/test_project/test.cpp << 'EOF'
        #include <svm.h>
        int main() { return 0; }
        EOF
        cmake -B ${{github.workspace}}/test_project/build \
          -S ${{github.workspace}}/test_project \
          -DCMAKE_PREFIX_PATH=${{github.workspace}}/install
        cmake --build ${{github.workspace}}/test_project/build

  # ============================================================================
  # Code Coverage (Linux only)
  # ============================================================================
  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov

    - name: Configure CMake with coverage
      shell: bash
      env:
        MSYS2_ARG_CONV_EXCL: "*"
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_C_FLAGS="--coverage" \
          -DLIBSVM_BUILD_APPS=ON

    - name: Build
      shell: bash
      run: cmake --build ${{github.workspace}}/build

    - name: Run tests
      shell: bash
      run: |
        ${{github.workspace}}/build/bin/svm-train \
          ${{github.workspace}}/examples/data/heart_scale \
          ${{github.workspace}}/build/heart_scale.model
        ${{github.workspace}}/build/bin/svm-predict \
          ${{github.workspace}}/examples/data/heart_scale \
          ${{github.workspace}}/build/heart_scale.model \
          ${{github.workspace}}/build/heart_scale.output

    - name: Generate coverage report
      shell: bash
      run: |
        lcov --capture --directory ${{github.workspace}}/build \
          --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/test/*' \
          --output-file coverage.info --ignore-errors unused
        lcov --list coverage.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      continue-on-error: true
      with:
        files: ./coverage.info
